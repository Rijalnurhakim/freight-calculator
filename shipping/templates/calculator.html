{% extends 'base.html' %}

{% block title %}Freight Calculator{% endblock %}

{% block page_title %}Freight Calculator{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-calculator me-2"></i>Calculate Shipping Cost
                </h6>
            </div>
            <div class="card-body">
                <div id="calculator-app">
                    <!-- Vue.js calculator will be mounted here -->
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading calculator...</span>
                        </div>
                        <p class="mt-2">Loading freight calculator...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script>
const { createApp } = Vue;

createApp({
    data() {
        return {
            loading: false,
            countries: [],
            categories: [],
            destinations: [],
            selectedCountry: null,
            selectedCategory: null,
            selectedDestination: null,
            weight: '',
            result: null,
            error: null,
            searchDestination: ''
        }
    },
    async mounted() {
        await this.loadCountries();
        this.renderCalculator();
    },
    methods: {
        async loadCountries() {
            try {
                const response = await axios.get('/api/countries/');
                this.countries = response.data;
            } catch (error) {
                this.error = 'Failed to load countries';
            }
        },
        async loadCategories() {
            if (!this.selectedCountry) return;
            
            try {
                const response = await axios.get(`/api/categories/?country_id=${this.selectedCountry.id}`);
                this.categories = response.data;
                this.selectedCategory = null;
            } catch (error) {
                this.error = 'Failed to load categories';
            }
        },
        async searchDestinations() {
            if (this.searchDestination.length < 3) {
                this.destinations = [];
                return;
            }
            
            try {
                const response = await axios.get(`/api/destination/?search=${this.searchDestination}`);
                this.destinations = response.data;
            } catch (error) {
                this.error = 'Failed to search destinations';
            }
        },
        async calculateFreight() {
            if (!this.selectedCountry || !this.selectedCategory || !this.selectedDestination || !this.weight) {
                this.error = 'Please fill all fields';
                return;
            }
            
            this.loading = true;
            this.error = null;
            
            try {
                const response = await axios.post('/api/calculate/', {
                    country_id: this.selectedCountry.id,
                    category_id: this.selectedCategory.id,
                    destination_id: this.selectedDestination.id,
                    weight: parseFloat(this.weight)
                });
                
                this.result = response.data;
            } catch (error) {
                this.error = error.response?.data?.error || 'Calculation failed';
            } finally {
                this.loading = false;
            }
        },
        formatCurrency(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR'
            }).format(amount);
        },
        renderCalculator() {
            const calculatorHtml = `
                <div class="row">
                    <div class="col-md-6">
                        <h5 class="mb-3">Calculate Shipping Cost</h5>
                        
                        <!-- Country Selection -->
                        <div class="mb-3">
                            <label class="form-label">Origin Country</label>
                            <select v-model="selectedCountry" @change="loadCategories" class="form-select">
                                <option value="">Select Country</option>
                                <option v-for="country in countries" :key="country.id" :value="country">
                                    {{country.country_name}}
                                </option>
                            </select>
                        </div>
                        
                        <!-- Category Selection -->
                        <div class="mb-3">
                            <label class="form-label">Product Category</label>
                            <select v-model="selectedCategory" class="form-select" :disabled="!selectedCountry">
                                <option value="">Select Category</option>
                                <option v-for="category in categories" :key="category.id" :value="category">
                                    {{category.category_title}}
                                </option>
                            </select>
                        </div>
                        
                        <!-- Destination Search -->
                        <div class="mb-3">
                            <label class="form-label">Destination</label>
                            <input 
                                v-model="searchDestination" 
                                @input="searchDestinations"
                                type="text" 
                                class="form-control" 
                                placeholder="Search destination city..."
                            >
                            <div v-if="destinations.length > 0" class="mt-2">
                                <div class="list-group">
                                    <button 
                                        v-for="dest in destinations" 
                                        :key="dest.id"
                                        @click="selectedDestination = dest; searchDestination = dest.city_name"
                                        class="list-group-item list-group-item-action"
                                        :class="{ active: selectedDestination?.id === dest.id }"
                                    >
                                        {{dest.city_name}}, {{dest.province}}
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Weight Input -->
                        <div class="mb-3">
                            <label class="form-label">Weight (kg)</label>
                            <input v-model="weight" type="number" step="0.1" class="form-control" placeholder="Enter weight in kg">
                        </div>
                        
                        <!-- Calculate Button -->
                        <button 
                            @click="calculateFreight" 
                            class="btn btn-primary w-100"
                            :disabled="loading"
                        >
                            <span v-if="loading" class="spinner-border spinner-border-sm me-2"></span>
                            <span v-if="loading">Calculating...</span>
                            <span v-else>Calculate</span>
                        </button>
                        
                        <!-- Error Message -->
                        <div v-if="error" class="alert alert-danger mt-3">
                            {{error}}
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <!-- Result Display -->
                        <div v-if="result" class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Calculation Result</h5>
                            </div>
                            <div class="card-body">
                                <div class="row mb-2">
                                    <div class="col-6"><strong>Origin:</strong></div>
                                    <div class="col-6">{{result.origin}}</div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-6"><strong>Destination:</strong></div>
                                    <div class="col-6">{{result.destination}}</div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-6"><strong>Category:</strong></div>
                                    <div class="col-6">{{result.category_name}}</div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-6"><strong>Weight:</strong></div>
                                    <div class="col-6">{{result.weight}} kg</div>
                                </div>
                                <hr>
                                <div class="row mb-2">
                                    <div class="col-6"><strong>International Price:</strong></div>
                                    <div class="col-6">{{formatCurrency(result.international_price)}}</div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-6"><strong>Domestic Price:</strong></div>
                                    <div class="col-6">{{formatCurrency(result.domestic_price)}}</div>
                                </div>
                                <hr>
                                <div class="row">
                                    <div class="col-6"><strong>Total Price:</strong></div>
                                    <div class="col-6"><strong class="text-primary">{{formatCurrency(result.total_price)}}</strong></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Sample Result for Demo -->
                        <div v-else class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Sample Calculation</h5>
                            </div>
                            <div class="card-body">
                                <div class="text-center text-muted">
                                    <i class="fas fa-calculator fa-3x mb-3"></i>
                                    <p>Fill the form on the left to calculate shipping cost</p>
                                    <small>Example: China → Surabaya, Electronics, 15 kg</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('calculator-app').innerHTML = calculatorHtml;
        }
    },
    watch: {
        selectedCountry() {
            this.loadCategories();
        },
        searchDestination() {
            this.searchDestinations();
        }
    }
}).mount('#calculator-app');
</script>
{% endblock %}

